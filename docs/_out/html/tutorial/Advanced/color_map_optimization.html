

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Color Map Optimization &mdash; Open3D latest (cf20af6) documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/open3d_logo.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Customized visualization" href="customized_visualization.html" />
    <link rel="prev" title="RGBD integration" href="rgbd_integration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Open3D
          

          
          </a>

          
            
            
              <div class="version">
                latest (cf20af6)
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">About Open3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../compilation.html">Compiling from source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../builddocs.html">Building Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contributing to Open3D</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Basic/index.html">Basic</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pointcloud_outlier_removal.html">Point cloud outlier removal</a></li>
<li class="toctree-l2"><a class="reference internal" href="colored_pointcloud_registration.html">Colored point cloud registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="global_registration.html">Global registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="fast_global_registration.html">Fast global registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiway_registration.html">Multiway registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="rgbd_integration.html">RGBD integration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Color Map Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#input">Input</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rigid-optimization">Rigid Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-rigid-optimization">Non-rigid Optimization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="customized_visualization.html">Customized visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_blocking_visualization.html">Non-blocking visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactive_visualization.html">Interactive visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="headless_rendering.html">Headless rendering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ReconstructionSystem/index.html">Reconstruction system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../C++/cplusplus_interface.html">C++ interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/index.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.camera.html">open3d.camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.color_map.html">open3d.color_map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.geometry.html">open3d.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.io.html">open3d.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.integration.html">open3d.integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.odometry.html">open3d.odometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.registration.html">open3d.registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.utility.html">open3d.utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/open3d.visualization.html">open3d.visualization</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Open3D</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Advanced</a> &raquo;</li>
        
      <li>Color Map Optimization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="color-map-optimization">
<span id="id1"></span><h1>Color Map Optimization<a class="headerlink" href="#color-map-optimization" title="Permalink to this headline">Â¶</a></h1>
<p>Consider color mapping to the geometry reconstructed from depth cameras. As color and depth frames are not perfectly aligned, the texture mapping using color images is subject to results in blurred color map. Open3D provides color map optimization method proposed by <a class="reference internal" href="../reference.html#zhou2014" id="id2"><span>[Zhou2014]</span></a>. Before begin, download fountain dataset from <a class="reference external" href="https://drive.google.com/open?id=1eT45y8qw3TLED2YY9-K1Ot6dQuF9GDPJ">here</a>. The following script shows an example of color map optimization.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># examples/Python/Advanced/o3d.color_map.color_map_optimization.py</span>

<span class="kn">import</span> <span class="nn">open3d</span> <span class="kn">as</span> <span class="nn">o3d</span>
<span class="kn">from</span> <span class="nn">trajectory_io</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../Utility&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">file</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;[path_to_fountain_dataset]&quot;</span>
<span class="n">debug_mode</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">set_verbosity_level</span><span class="p">(</span><span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">VerbosityLevel</span><span class="o">.</span><span class="n">Debug</span><span class="p">)</span>

    <span class="c1"># Read RGBD images</span>
    <span class="n">rgbd_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">depth_image_path</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;depth/&quot;</span><span class="p">),</span>
                                     <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span>
    <span class="n">color_image_path</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;image/&quot;</span><span class="p">),</span>
                                     <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_image_path</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">)):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">color_image_path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">rgbd_image</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">RGBDImage</span><span class="o">.</span><span class="n">create_from_color_and_depth</span><span class="p">(</span>
            <span class="n">color</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">convert_rgb_to_intensity</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug_mode</span><span class="p">:</span>
            <span class="n">pcd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="o">.</span><span class="n">create_from_rgbd_image</span><span class="p">(</span>
                <span class="n">rgbd_image</span><span class="p">,</span>
                <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span>
                    <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsicParameters</span><span class="o">.</span>
                    <span class="n">PrimeSenseDefault</span><span class="p">))</span>
            <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">pcd</span><span class="p">])</span>
        <span class="n">rgbd_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgbd_image</span><span class="p">)</span>

    <span class="c1"># Read camera pose and mesh</span>
    <span class="n">camera</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_pinhole_camera_trajectory</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene/key.log&quot;</span><span class="p">))</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;integrated.ply&quot;</span><span class="p">))</span>

    <span class="c1"># Before full optimization, let&#39;s just visualize texture map</span>
    <span class="c1"># with given geometry, RGBD images, and camera poses.</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">ColorMapOptimizationOption</span><span class="p">()</span>
    <span class="n">option</span><span class="o">.</span><span class="n">maximum_iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">color_map_optimization</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rgbd_images</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">mesh</span><span class="p">])</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;color_map_before_optimization.ply&quot;</span><span class="p">),</span> <span class="n">mesh</span><span class="p">)</span>

    <span class="c1"># Optimize texture and save the mesh as texture_mapped.ply</span>
    <span class="c1"># This is implementation of following paper</span>
    <span class="c1"># Q.-Y. Zhou and V. Koltun,</span>
    <span class="c1"># Color Map Optimization for 3D Reconstruction with Consumer Depth Cameras,</span>
    <span class="c1"># SIGGRAPH 2014</span>
    <span class="n">option</span><span class="o">.</span><span class="n">maximum_iteration</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">option</span><span class="o">.</span><span class="n">non_rigid_camera_coordinate</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">color_map_optimization</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rgbd_images</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">mesh</span><span class="p">])</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;color_map_after_optimization.ply&quot;</span><span class="p">),</span> <span class="n">mesh</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="input">
<h2>Input<a class="headerlink" href="#input" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Read RGBD images</span>
    <span class="n">rgbd_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">depth_image_path</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;depth/&quot;</span><span class="p">),</span>
                                     <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span>
    <span class="n">color_image_path</span> <span class="o">=</span> <span class="n">get_file_list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;image/&quot;</span><span class="p">),</span>
                                     <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_image_path</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">)):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">depth_image_path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">color_image_path</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">rgbd_image</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">RGBDImage</span><span class="o">.</span><span class="n">create_from_color_and_depth</span><span class="p">(</span>
            <span class="n">color</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">convert_rgb_to_intensity</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug_mode</span><span class="p">:</span>
            <span class="n">pcd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="o">.</span><span class="n">create_from_rgbd_image</span><span class="p">(</span>
                <span class="n">rgbd_image</span><span class="p">,</span>
                <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsic</span><span class="p">(</span>
                    <span class="n">o3d</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">PinholeCameraIntrinsicParameters</span><span class="o">.</span>
                    <span class="n">PrimeSenseDefault</span><span class="p">))</span>
            <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">pcd</span><span class="p">])</span>
        <span class="n">rgbd_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgbd_image</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This script reads color and depth image pairs and makes <code class="docutils literal notranslate"><span class="pre">rgbd_image</span></code>. Note that <code class="docutils literal notranslate"><span class="pre">convert_rgb_to_intensity</span></code> flag is <code class="docutils literal notranslate"><span class="pre">False</span></code>. This is to preserve 8-bit color channels instead of using single channel float type image.</p>
<p>It is always good practice to visualize RGBD image before applying it to color map optimization. <code class="docutils literal notranslate"><span class="pre">debug_mode</span></code> switch is for visualizing RGBD image.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Read camera pose and mesh</span>
    <span class="n">camera</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_pinhole_camera_trajectory</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene/key.log&quot;</span><span class="p">))</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;integrated.ply&quot;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>The script reads camera trajectory and mesh.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Before full optimization, let&#39;s just visualize texture map</span>
    <span class="c1"># with given geometry, RGBD images, and camera poses.</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">ColorMapOptimizationOption</span><span class="p">()</span>
    <span class="n">option</span><span class="o">.</span><span class="n">maximum_iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">color_map_optimization</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rgbd_images</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">mesh</span><span class="p">])</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;color_map_before_optimization.ply&quot;</span><span class="p">),</span> <span class="n">mesh</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>To visualize how the camera poses are not good for color mapping, this script intentionally set the iteration number as 0, which means no optimization. <code class="docutils literal notranslate"><span class="pre">color_map_optimization</span></code> paints a mesh using corresponding RGBD images and camera poses. Without optimization, the texture map is blurred.</p>
<a class="reference internal image-reference" href="../../_images/initial3.png"><img alt="../../_images/initial3.png" src="../../_images/initial3.png" style="width: 300px;" /></a>
<a class="reference internal image-reference" href="../../_images/initial_zoom.png"><img alt="../../_images/initial_zoom.png" src="../../_images/initial_zoom.png" style="width: 300px;" /></a>
</div>
<div class="section" id="rigid-optimization">
<h2>Rigid Optimization<a class="headerlink" href="#rigid-optimization" title="Permalink to this headline">Â¶</a></h2>
<p>The next step is to optimize camera poses to get a sharp color map.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="c1"># Optimize texture and save the mesh as texture_mapped.ply</span>
    <span class="c1"># This is implementation of following paper</span>
    <span class="c1"># Q.-Y. Zhou and V. Koltun,</span>
    <span class="c1"># Color Map Optimization for 3D Reconstruction with Consumer Depth Cameras,</span>
    <span class="c1"># SIGGRAPH 2014</span>
    <span class="n">option</span><span class="o">.</span><span class="n">maximum_iteration</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">option</span><span class="o">.</span><span class="n">non_rigid_camera_coordinate</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">color_map</span><span class="o">.</span><span class="n">color_map_optimization</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rgbd_images</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">mesh</span><span class="p">])</span>
    <span class="n">o3d</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_triangle_mesh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;scene&quot;</span><span class="p">,</span> <span class="s2">&quot;color_map_after_optimization.ply&quot;</span><span class="p">),</span> <span class="n">mesh</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The script sets <code class="docutils literal notranslate"><span class="pre">maximum_iteration</span> <span class="pre">=</span> <span class="pre">300</span></code> for actual iterations. The optimization displays the following energy profile.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>ColorMapOptimization<span class="o">]</span> :: Rigid Optimization
<span class="o">[</span>Iteration <span class="m">0001</span><span class="o">]</span> Residual error : <span class="m">21639</span>.276499 <span class="o">(</span>avg : <span class="m">0</span>.004615<span class="o">)</span>
<span class="o">[</span>Iteration <span class="m">0002</span><span class="o">]</span> Residual error : <span class="m">21461</span>.765357 <span class="o">(</span>avg : <span class="m">0</span>.004577<span class="o">)</span>
<span class="o">[</span>Iteration <span class="m">0003</span><span class="o">]</span> Residual error : <span class="m">21284</span>.579715 <span class="o">(</span>avg : <span class="m">0</span>.004540<span class="o">)</span>
:
<span class="o">[</span>Iteration <span class="m">0298</span><span class="o">]</span> Residual error : <span class="m">8891</span>.042884 <span class="o">(</span>avg : <span class="m">0</span>.001903<span class="o">)</span>
<span class="o">[</span>Iteration <span class="m">0299</span><span class="o">]</span> Residual error : <span class="m">8890</span>.037077 <span class="o">(</span>avg : <span class="m">0</span>.001903<span class="o">)</span>
<span class="o">[</span>Iteration <span class="m">0300</span><span class="o">]</span> Residual error : <span class="m">8888</span>.970765 <span class="o">(</span>avg : <span class="m">0</span>.001903<span class="o">)</span>
</pre></div>
</div>
<p>Residual error implies inconsistency of image intensities. Lower residual leads better color map quality. By default, <code class="docutils literal notranslate"><span class="pre">ColorMapOptimizationOption</span></code> enables rigid optimization. It optimizes 6-dimentional pose of every cameras.</p>
<a class="reference internal image-reference" href="../../_images/rigid.png"><img alt="../../_images/rigid.png" src="../../_images/rigid.png" style="width: 300px;" /></a>
<a class="reference internal image-reference" href="../../_images/rigid_zoom.png"><img alt="../../_images/rigid_zoom.png" src="../../_images/rigid_zoom.png" style="width: 300px;" /></a>
</div>
<div class="section" id="non-rigid-optimization">
<h2>Non-rigid Optimization<a class="headerlink" href="#non-rigid-optimization" title="Permalink to this headline">Â¶</a></h2>
<p>For better alignment quality, there is an option for non-rigid optimization. To enable, simply add</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="o">.</span><span class="n">non_rigid_camera_coordinate</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>before calling <code class="docutils literal notranslate"><span class="pre">color_map_optimization</span></code>. Besides 6-dimentional camera poses, non-rigid optimization even consider local image warping represented by anchor points. This adds even more flexibility and leads higher quality color mapping. The residual error is smaller than the case of rigid optimization.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>ColorMapOptimization<span class="o">]</span> :: Non-Rigid Optimization
<span class="o">[</span>Iteration <span class="m">0001</span><span class="o">]</span> Residual error : <span class="m">21639</span>.276499, reg : <span class="m">0</span>.000000
<span class="o">[</span>Iteration <span class="m">0002</span><span class="o">]</span> Residual error : <span class="m">21187</span>.225206, reg : <span class="m">13</span>.918495
<span class="o">[</span>Iteration <span class="m">0003</span><span class="o">]</span> Residual error : <span class="m">20745</span>.248996, reg : <span class="m">42</span>.234724
:
<span class="o">[</span>Iteration <span class="m">0298</span><span class="o">]</span> Residual error : <span class="m">5589</span>.018747, reg : <span class="m">2745</span>.364742
<span class="o">[</span>Iteration <span class="m">0299</span><span class="o">]</span> Residual error : <span class="m">5587</span>.180145, reg : <span class="m">2746</span>.619137
<span class="o">[</span>Iteration <span class="m">0300</span><span class="o">]</span> Residual error : <span class="m">5585</span>.066255, reg : <span class="m">2747</span>.902979
</pre></div>
</div>
<p>Results of non-rigid optimization follow.</p>
<a class="reference internal image-reference" href="../../_images/non_rigid.png"><img alt="../../_images/non_rigid.png" src="../../_images/non_rigid.png" style="width: 300px;" /></a>
<a class="reference internal image-reference" href="../../_images/non_rigid_zoom.png"><img alt="../../_images/non_rigid_zoom.png" src="../../_images/non_rigid_zoom.png" style="width: 300px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the residual error does not stably decrease, it is mainly because images are being bended abruptly. In this case, consider making iteration more conservative by increasing <code class="docutils literal notranslate"><span class="pre">option.non_rigid_anchor_point_weight</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="customized_visualization.html" class="btn btn-neutral float-right" title="Customized visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rgbd_integration.html" class="btn btn-neutral float-left" title="RGBD integration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018 - 2019, www.open3d.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
<span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Docs version</span>
    latest (cf20af6)
    <span class="fa fa-caret-down"></span>
</span>

<!-- A hack to include an external page to get around CORS policy -->
<!-- https://stackoverflow.com/a/15250208/1255535 -->
<div class="rst-other-versions">
    <dl>
    <dt>Versions</dt>
        <dd><ul>
            <script src="http://www.open3d.org/docs/versions.js"></script>
        </ul></dd>
    </dl>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>